# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Docker image tag management tool that validates tags. When an image is published, in additional to traditional semanitic versioned tag (ie. MAJOR.MINOR.PATCH), several mutable tags might be published as well. The tool validates those mutable tags (like `latest`, major versions `1`, `2`, minor versions `1.2`, etc.) mapped correctly to its semantic versioned image tags. 

## Architecture

The project consists of several components:

- **Shell Script (`src/import-mutable-tags.sh`)**: Fetch (with `glcoud` CLI) image tags (with `glcoud` CLI) and their digests, filters out unwanted tags, creates JSON mappings, and write a file under `./fixtures`.
- **Shell Script (`src/import-semantic-tags.sh`)**: Fetch (with `glcoud` CLI) image tags (with `glcoud` CLI) and their digests, only keep the semantic tags, creates JSON mappings, and write a file under `./fixtures`.
- **Ruby Script (`src/compute.rb`)**: Takes semantic versioned tags and generates mutable tag mappings following semantic versioning principles and write to a file under `./fixtures`
- RSpec validates equilibrium (same keys and value) between the mutable tags generated by `src/compute.rb` and fetching mutable tags directly.

## Key Files

- `src/main.sh`: Main orchestration script that queries container registries and calls the Ruby converter
- `src/import-semantic-tags.sh`: Script to fetch and process semantic versioned tags
- `src/import-mutable-tags.sh`: Script to fetch mutable tags directly from registry
- `src/compute.rb`: Ruby utility that converts semantic version tags to mutable tags (latest, major, minor)
- `spec/equilibrium_spec.rb`: RSpec tests validating equilibrium between outputs
- `fixtures/`: Directory for generated JSON files (registry-specific, not committed to git)

## Development Commands

### Running Tests
```bash
bundle install
bundle exec rspec spec/
```

### Code Linting and Formatting

#### Ruby code
```bash
# Check for style issues
bundle exec standardrb

# Auto-fix style issues
bundle exec standardrb --fix
```

#### Shell scripts
```bash
# Install ShellCheck (macOS)
brew install shellcheck

# Check all shell scripts
shellcheck src/*.sh

# Check specific script
shellcheck src/main.sh
```

### Running the Main Script
```bash
./src/main.sh <registry/image>
```

Example:
```bash
./src/main.sh gcr.io/datadoghq/apm-inject
./src/main.sh gcr.io/datadoghq/dd-lib-ruby-init
./src/main.sh gcr.io/datadoghq/dd-trace-java
```

### Running Individual Scripts
```bash
./src/import-semantic-tags.sh <registry/image>
./src/import-mutable-tags.sh <registry/image>
```

### Running the Ruby Converter Standalone
```bash
ruby src/compute.rb fixtures/<registry_dir>/tag_digest_mapping.json [output_file]
```

## Output Files

When you run the tool with different registries, it creates registry-specific directories under `fixtures/` to organize outputs:

```
fixtures/
├── gcr_io_datadoghq_apm_inject/
│   ├── tag_digest_mapping.json          # Semantic version tags from registry
│   ├── mutable_tag_mapping.json         # Mutable tags fetched directly
│   └── computed_mutable_tags.json       # Computed mutable tags from semantic versions
└── gcr_io_datadoghq_dd_lib_ruby_init/
    ├── tag_digest_mapping.json
    ├── mutable_tag_mapping.json
    └── computed_mutable_tags.json
```

Directory names are created by replacing special characters with underscores:
- `gcr.io/datadoghq/apm-inject` → `fixtures/gcr_io_datadoghq_apm_inject/`
- `gcr.io/datadoghq/dd-lib-ruby-init` → `fixtures/gcr_io_datadoghq_dd_lib_ruby_init/`

## Dependencies

- Ruby with Bundler
- `gcloud` CLI with proper authentication and registry access permissions
- `jq` for JSON processing in shell scripts
- `shellcheck` for shell script linting (optional)

### Setup

#### 1. Install Ruby dependencies
```bash
bundle install
```

#### 2. Configure gcloud authentication
```bash
# Authenticate with Google Cloud
gcloud auth login

# Set your project (replace with your actual project ID)
gcloud config set project YOUR_PROJECT_ID

# Configure Docker authentication for GCR (if needed)
gcloud auth configure-docker
```

#### 3. Verify access to target registries
```bash
# Test access to a registry
gcloud container images list-tags gcr.io/datadoghq/apm-inject --limit=1
```

**Note**: This tool currently works with Google Container Registry (GCR) and Artifact Registry. You need appropriate IAM permissions to read container images from the target registries.

## Data Flow

1. Script queries the specified container registry for all tags of the target image
2. Filters to keep only semantic version tags (e.g., `1.2.3`)
3. Ruby script processes these to create mutable tags:
   - `latest`: highest semantic version
   - Major tags (`1`, `2`): highest version for each major
   - Minor tags (`1.2`, `1.3`): highest patch for each major.minor
4. Outputs are validated for consistency between different processing paths